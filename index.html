<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Digital Portfolio Card</title>

  <style>
    /* ===============================
       BASE / RESET
       Normalize default browser styles
       =============================== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    /* ===============================
       PAGE LAYOUT
       Full-screen centered layout with gradient background
       =============================== */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at center, white 0%, #6B46C1 100%);
      position: relative;
      overflow-x: hidden;
      overflow-y: auto;
      /* Generous padding to prevent content from being hidden by fixed buttons */
      padding: 90px 20px 120px;
    }

    /* ===============================
       FLOATING BUTTONS (Home / Share / Settings)
       Fixed position navigation buttons
       =============================== */
    .home-btn,
    .settings-btn,
    .share-btn {
      position: fixed;
      top: 15px;
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.95);
      border: 2px solid rgba(107, 70, 193, 0.3);
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 100;
      transition: all 0.3s;
    }

    /* Position each button */
    .home-btn     { left: 15px; }
    .settings-btn { right: 15px; }
    .share-btn    { left: 50%; transform: translateX(-50%); }

    /* Hover effects for all floating buttons */
    .home-btn:hover,
    .settings-btn:hover,
    .share-btn:hover {
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3);
      transform: scale(1.05);
    }

    /* Keep share button centered on hover */
    .share-btn:hover {
      transform: translateX(-50%) scale(1.05);
    }

    /* Settings gear icon rotation effect */
    .settings-btn:hover { transform: none; }
    .settings-btn .settings-btn-inner {
      display: inline-flex;
      width: 24px;
      height: 24px;
      align-items: center;
      justify-content: center;
      transition: transform .2s ease;
    }
    .settings-btn:hover .settings-btn-inner { transform: scale(1.05); }
    .settings-btn .gear {
      display: block;
      transform-origin: 50% 50%;
      transform-box: fill-box;
      transition: transform .25s linear;
      will-change: transform;
      backface-visibility: hidden;
    }
    .settings-btn:hover .gear {
      animation: none;
      transform: rotate(180deg);
    }

    /* ===============================
       SAVE CONTACT BUTTON
       Only visible when viewing someone else's shared card
       =============================== */
    .save-contact-btn {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      padding: 15px 30px;
      background: white;
      color: #6366f1;
      border: 2px solid #6366f1;
      border-radius: 50px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      z-index: 100;
      transition: all 0.3s;
      display: none; /* Hidden by default */
    }

    /* Show the button with animation when viewing shared card */
    .save-contact-btn.show {
      display: block;
      animation: slideUpFade 0.5s ease-out;
    }

    @keyframes slideUpFade {
      from { opacity: 0; transform: translateX(-50%) translateY(20px); }
      to   { opacity: 1; transform: translateX(-50%) translateY(0); }
    }

    .save-contact-btn:hover {
      background: #6366f1;
      color: white;
      transform: translateX(-50%) translateY(-2px);
      box-shadow: 0 6px 20px rgba(99, 102, 241, 0.4);
    }

    /* ===============================
       BUSINESS CARD CONTAINER
       3D flip card with entrance animation
       =============================== */
    .card-container {
      width: 480px;
      height: 280px;
      perspective: 1500px; /* Required for 3D effects */
      cursor: pointer;
      /* Dramatic entrance animation */
      animation: slideUp 3.5s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards;
      opacity: 0;
      transform: translateY(100vh);
      max-width: 90vw;
      transition: transform 0.1s ease-out;
      flex-shrink: 0;
    }

    /* Card slides up from bottom with spinning effect */
    @keyframes slideUp {
      0%   { opacity: 0; transform: translateY(100vh) rotateY(0deg); }
      50%  { opacity: 1; transform: translateY(0) rotateY(720deg); }
      100% { opacity: 1; transform: translateY(0) rotateY(720deg); }
    }

    /* Card wrapper for 3D flip effect */
    .card {
      width: 100%;
      height: 100%;
      position: relative;
      transform-style: preserve-3d; /* Enable 3D transforms */
      transition: transform 0.7s;
    }

    /* Flipped state - rotates 180 degrees on Y axis */
    .card.flipped { transform: rotateY(180deg); }

    /* Base styles for both card faces */
    .card-face {
      position: absolute;
      width: 100%;
      height: 100%;
      backface-visibility: hidden; /* Hide the back when facing away */
      -webkit-backface-visibility: hidden;
      -moz-backface-visibility: hidden;
      border-radius: 20px;
      /* Layered shadows for depth and glow */
      box-shadow:
        0 10px 40px rgba(0, 0, 0, 0.3),
        0 0 30px rgba(99, 102, 241, 0.5),
        inset 0 0 20px rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* Front face - Profile picture with animated gradient */
    .card-front {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #6366f1 100%);
      background-size: 200% 200%;
      animation: gradientShift 3s ease infinite;
      z-index: 2;
    }

    /* Hide/show faces based on flip state */
    .card.flipped .card-front { visibility: hidden; opacity: 0; }
    .card:not(.flipped) .card-back { visibility: hidden; opacity: 0; }

    /* Subtle gradient animation on front */
    @keyframes gradientShift {
      0%, 100% { background-position: 0% 50%; }
      50%      { background-position: 100% 50%; }
    }

    /* Back face - Contact information */
    .card-back {
      background: #6366f1;
      transform: rotateY(180deg); /* Pre-rotated so it appears correctly when card flips */
      padding: 24px;
      position: relative;
      overflow: hidden;
      display: block;
      color: var(--card-text, #fff); /* Dynamic color based on card background */
    }

    /* All links on back inherit the dynamic text color */
    .card-back a {
      color: var(--card-text, #fff) !important;
      text-decoration: none;
    }

    /* ===============================
       PROFILE PICTURES
       =============================== */
    
    /* Large profile picture on front of card */
    .profile-pic {
      width: 200px;
      height: 200px;
      border-radius: 50%;
      object-fit: cover;
      border: 5px solid white;
      box-shadow:
        0 5px 20px rgba(0, 0, 0, 0.3),
        0 0 30px rgba(255, 255, 255, 0.5);
      /* Subtle pulsing glow effect */
      animation: profilePulse 2s ease-in-out infinite;
      position: relative;
      z-index: 1;
    }

    @keyframes profilePulse {
      0%, 100% { box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3), 0 0 30px rgba(255, 255, 255, 0.5); }
      50%      { box-shadow: 0 5px 25px rgba(0, 0, 0, 0.4), 0 0 40px rgba(255, 255, 255, 0.8); }
    }

    /* Smaller profile picture on back of card */
    .profile-pic-small {
      position: absolute;
      top: 24px;
      right: 24px;
      width: 135px;
      height: 135px;
      border-radius: 16px;
      object-fit: cover;
      border: 3px solid white;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
      z-index: 10;
    }

    /* ===============================
       CARD BACK CONTENT LAYOUT
       =============================== */
    
    /* Main content container on back */
    .left-content {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      color: var(--card-text, #f9fafb);
      padding-right: 90px; /* Space for profile picture */
    }

    /* Contact information section */
    .contact-info {
      color: inherit;
      margin-bottom: 12px;
    }

    .contact-info h2 {
      font-size: 24px;
      margin-bottom: 0;
      font-weight: 600;
    }

    .contact-info a {
      display: block;
    }

    /* Individual contact detail row (email, phone, LinkedIn) */
    .contact-detail {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 8px;
      font-size: 13px;
    }

    .contact-detail svg { flex-shrink: 0; }

    /* Portfolio links section */
    .portfolio-links {
      margin-top: 15px;
      text-align: center;
    }

    .portfolio-links h3 {
      font-size: 11px;
      color: var(--card-text, #fff);
      opacity: 0.8;
      margin-bottom: 8px;
      letter-spacing: 1px;
      font-weight: 600;
      text-align: center;
    }

    /* Grid layout for portfolio buttons */
    .portfolio-links-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 6px;
      max-width: 560px;
      margin: 0 auto;
    }

    /* Individual portfolio button */
    .portfolio-link {
      background: var(--card-chip-bg, rgba(255, 255, 255, 0.2));
      border: none;
      color: var(--card-text, #fff);
      padding: 8px 10px;
      border-radius: 8px;
      cursor: pointer;
      width: 100%;
      text-align: center;
      transition: all 0.3s;
      font-size: 12px;
      display: block;
    }

    .portfolio-link:hover {
      background: var(--card-chip-bg-hover, rgba(255, 255, 255, 0.3));
      transform: scale(1.05);
    }

    .portfolio-link:active {
      background: var(--card-chip-bg-hover, rgba(255, 255, 255, 0.3));
      transform: scale(0.95);
    }

    /* Hidden right content (legacy) */
    .right-content { display: none; }

    /* ===============================
       HINT TEXT
       Pulsing instruction text for first-time users
       =============================== */
    .hint-text {
      position: fixed;
      bottom: 100px;
      left: 50%;
      transform: translateX(-50%);
      color: rgba(255, 255, 255, 0.8);
      font-size: 14px;
      animation: pulse 2s infinite;
      z-index: 50;
    }

    @keyframes pulse {
      0%, 100% { opacity: 0.8; }
      50%      { opacity: 0.4; }
    }

    /* ===============================
       PANELS (Home / Settings / Share)
       Full-screen overlay panels
       =============================== */
    .home-panel,
    .settings-panel,
    .share-panel {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: white;
      z-index: 200;
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* Show panel when active */
    .home-panel.active,
    .settings-panel.active,
    .share-panel.active {
      display: block;
    }

    /* Panel header with back button */
    .panel-header {
      background: white;
      padding: 20px;
      border-bottom: 1px solid #e5e7eb;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .back-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      padding: 10px;
    }

    /* ===============================
       HOME PANEL TABS
       Tab navigation for My Card / Saved Contacts
       =============================== */
    .tab-container {
      position: sticky;
      top: 0;
      z-index: 10;
      display: flex;
      justify-content: center;
      gap: 10px;
      margin-top: 10px;
      border-bottom: 2px solid #e5e7eb;
    }

    .tab {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 20px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 15px;
      font-weight: 500;
      color: #6b7280;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
      transition: all 0.2s;
    }

    /* Active tab styling */
    .tab.active {
      color: #6366f1;
      border-bottom-color: #6366f1;
    }

    /* Tab content visibility */
    .tab-content        { display: none; }
    .tab-content.active { display: block; }

    /* Home panel content wrapper */
    .home-content {
      max-width: 1200px;
      margin: 0 auto;
      padding: 30px;
    }

    /* Grid for displaying saved contact cards */
    .cards-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    /* Individual saved contact card */
    .saved-card {
      background: white;
      border: 2px solid #e5e7eb;
      border-radius: 12px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s;
      position: relative;
    }

    .saved-card:hover {
      border-color: #6366f1;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
      transform: translateY(-2px);
    }

    /* Saved card header with photo and name */
    .saved-card-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 15px;
    }

    .saved-card-pic {
      width: 60px;
      height: 60px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #e5e7eb;
    }

    .saved-card-info h3 { font-size: 18px; margin-bottom: 4px; }
    .saved-card-info p  { font-size: 14px; color: #6b7280; }

    /* Action buttons on saved cards */
    .saved-card-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .action-btn {
      flex: 1;
      padding: 8px;
      border: 1px solid #e5e7eb;
      background: white;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      transition: all 0.2s;
    }

    .action-btn:hover {
      background: #f9fafb;
      border-color: #6366f1;
    }

    /* Delete button styling */
    .delete-btn { background: #fee; border-color: #fcc; }
    .delete-btn:hover { background: #fdd; border-color: #f99; }

    /* ===============================
       MY CARD SECTION
       Preview of user's own business card in home panel
       =============================== */
    .my-card-section {
      background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
      border-radius: 12px;
      padding: 30px;
      color: white;
      margin-bottom: 30px;
    }

    .my-card-section h3 {
      font-size: 20px;
      margin-bottom: 20px;
      text-align: center;
    }

    .my-card-preview {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .my-card-pic {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid white;
    }

    .my-card-details h4 { font-size: 22px; margin-bottom: 8px; }
    .my-card-details p  { font-size: 14px; opacity: 0.9; }

    /* ===============================
       EMPTY STATE
       Shown when no contacts or card exists
       =============================== */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #6b7280;
    }

    .empty-state svg {
      margin: 0 auto 20px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 20px;
      margin-bottom: 10px;
      color: #374151;
    }

    .empty-state p {
      font-size: 14px;
    }

    /* Grid styling for empty states */
    .cards-grid {
      display: grid;
      min-height: 55vh;
    }

    .cards-grid > .empty-state {
      display: grid;
      place-items: center;
      justify-self: center;
      align-self: center;
      text-align: center;
      gap: 12px;
    }

    .cards-grid.is-empty {
      display: grid;
      grid-template-columns: 1fr;
      min-height: 55vh;
      place-items: center;
    }

    .cards-grid.is-empty .empty-state {
      text-align: center;
      max-width: 420px;
    }

    /* ===============================
       SHARE PANEL
       QR code generation and sharing
       =============================== */
    .share-content {
      max-width: 500px;
      margin: 0 auto;
      padding: 30px;
      text-align: center;
    }

    .qr-code-container {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      margin: 30px 0;
    }

    #qrcode {
      display: flex;
      justify-content: center;
      margin: 20px 0;
    }

    .share-instructions {
      color: #6b7280;
      font-size: 14px;
      margin: 20px 0;
      line-height: 1.6;
    }

    /* ===============================
       SETTINGS PANEL
       Form for editing card information
       =============================== */
    .settings-content {
      max-width: 600px;
      margin: 0 auto;
      padding: 30px 20px;
      box-sizing: border-box;
    }

    @media (min-width: 768px) {
      .settings-content {
        width: 600px;
        margin: 0 auto;
      }
    }

    @media (max-width: 767px) {
      .settings-content {
        padding: 20px 15px;
      }
    }

    .form-group {
      margin-bottom: 20px;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #374151;
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      max-width: 100%;
      padding: 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
    }

    /* Color picker group */
    .color-input-group {
      display: flex;
      gap: 10px;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }

    .color-input-group input[type="color"] {
      width: 80px;
      height: 45px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      cursor: pointer;
      flex-shrink: 0;
      box-sizing: border-box;
    }

    .color-input-group input[type="text"] {
      flex: 1;
      min-width: 0;
    }

    /* Save button */
    .save-btn {
      width: 100%;
      background: #111827;
      color: white;
      padding: 15px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 500;
      cursor: pointer;
      margin-top: 30px;
    }

    .save-btn:hover {
      background: #1f2937;
    }

    /* Section title divider */
    .section-title {
      font-size: 18px;
      font-weight: 600;
      color: #111827;
      margin: 30px 0 15px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      padding-bottom: 10px;
      border-bottom: 1px solid #e5e7eb;
    }

    /* Error message box for email validation */
    .email-error-box {
      background: #fee2e2;
      color: #b91c1c;
      font-size: 12px;
      padding: 10px;
      border-radius: 8px;
      margin-top: 6px;
      display: none;
      line-height: 1.4;
    }

    /* Phone number input group */
    .phone-inputs {
      display: flex;
      gap: 8px;
      width: 100%;
      max-width: 100%;
      box-sizing: border-box;
    }

    #countryCodeSelect {
      width: 140px;
      max-width: 140px;
      padding: 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      background: #fff;
      box-sizing: border-box;
    }

    #localNumberInput {
      flex: 1;
      padding: 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
      box-sizing: border-box;
      min-width: 0;
    }

    /* ===============================
       RESPONSIVE DESIGN
       Mobile and small screen optimizations
       =============================== */
    @media (max-width: 768px) {
      body {
        padding: 80px 15px 140px;
      }

      /* Larger, more prominent buttons on mobile */
      .home-btn,
      .settings-btn,
      .share-btn {
        width: 55px;
        height: 55px;
        top: 10px;
        background: rgba(255, 255, 255, 1);
        border: 3px solid #6B46C1;
      }

      .home-btn { left: 10px; }
      .settings-btn { right: 10px; }
      .share-btn { left: 50%; transform: translateX(-50%); }

      .card-container {
        height: 300px;
      }

      .cards-grid {
        grid-template-columns: 1fr;
      }

      .panel-header {
        flex-direction: column;
        gap: 15px;
        align-items: flex-start;
      }

      .my-card-preview {
        flex-direction: column;
        text-align: center;
      }

      .profile-pic-small {
        width: 85px;
        height: 85px;
        top: 12px;
        right: 12px;
      }

      .left-content {
        padding-right: 100px;
      }

      /* Center portfolio links on mobile with slight offset for visual balance */
      .portfolio-links {
        width: 100%;
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .portfolio-links-grid {
        max-width: 240px;
        transform: translate(35px);
      }

      .hint-text {
        bottom: 110px;
        font-size: 13px;
      }

      .save-contact-btn {
        bottom: 20px;
        font-size: 14px;
        padding: 12px 24px;
      }
    }

    /* Landscape mobile optimization */
    @media (orientation: landscape) and (max-width: 915px) {
      .card-container {
        width: 60vw;
        height: 70vh;
        max-height: 350px;
      }

      .profile-pic {
        width: 180px;
        height: 180px;
      }

      .profile-pic-small {
        width: 85px;
        height: 85px;
      }

      .card-back {
        padding: 20px;
      }
    }

    /* Very small phone optimization */
    @media (max-width: 400px) and (orientation: portrait) {
      body {
        padding: 75px 10px 150px;
      }

      .card-container {
        width: 85vw;
        height: 280px;
      }

      .profile-pic {
        width: 160px;
        height: 160px;
      }

      .contact-info h2 {
        font-size: 18px;
      }

      .contact-detail {
        font-size: 12px;
      }

      .profile-pic-small {
        width: 80px;
        height: 80px;
        top: 10px;
        right: 10px;
      }

      .card-back {
        padding: 16px;
      }

      .left-content {
        padding-right: 95px;
      }
    }

    /* Desktop optimization */
    @media (min-width: 768px) {
      .card-container {
        width: 520px;
        height: 300px;
      }

      .profile-pic {
        width: 220px;
        height: 220px;
      }

      .profile-pic-small {
        width: 135px;
        height: 135px;
      }
    }
  </style>
</head>

<body>
  <!-- =================================
       FLOATING NAVIGATION BUTTONS
       Always visible fixed buttons for navigation
       ================================= -->
  <button class="home-btn" onclick="openHome()" aria-label="Open home panel">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
      <polyline points="9 22 9 12 15 12 15 22"></polyline>
    </svg>
  </button>

  <button class="share-btn" onclick="openShare()" id="shareButton" aria-label="Open share panel">
    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
      <path d="M4 12v8a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2v-8"></path>
      <polyline points="16 6 12 2 8 6"></polyline>
      <line x1="12" y1="2" x2="12" y2="15"></line>
    </svg>
  </button>

  <button class="settings-btn" onclick="openSettings()" aria-label="Open settings">
    <span class="settings-btn-inner">
      <svg class="gear" width="24" height="24" viewBox="0 0 24 24" fill="none"
           stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 1 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
      </svg>
    </span>
  </button>

  <!-- =================================
       SAVE CONTACT BUTTON
       Only visible when viewing someone else's shared card
       ================================= -->
  <button class="save-contact-btn" id="saveContactBtn" onclick="saveContact()">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: inline; vertical-align: middle; margin-right: 8px;">
      <path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path>
    </svg>
    Save to My Contacts
  </button>

  <!-- =================================
       BUSINESS CARD
       3D flip card with front and back faces
       ================================= -->
  <div class="card-container" onclick="flipCard()">
    <div class="card" id="businessCard">

      <!-- FRONT FACE: Large profile picture -->
      <div class="card-face card-front" id="cardFront">
        <img
          src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=400"
          alt="Profile"
          class="profile-pic"
          id="profilePic"
        />
      </div>

      <!-- BACK FACE: Contact information and portfolio links -->
      <div class="card-face card-back" id="cardBack">
        <!-- Small profile picture in corner -->
        <img
          src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=400"
          alt="Profile"
          class="profile-pic-small"
          id="profilePicSmall"
        />

        <div class="left-content">
          <!-- Contact information section -->
          <div>
            <div class="contact-info">
              <!-- Name links to LinkedIn profile -->
              <a id="nameLink" target="_blank" style="color: white; text-decoration: none;">
                <h2 id="fullName">John Doe</h2>
                <div id="jobTitle" style="font-size:14px;opacity:.9;margin:4px 0 10px;"></div>
              </a>
            </div>

            <!-- Email -->
            <div class="contact-detail">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path>
                <polyline points="22,6 12,13 2,6"></polyline>
              </svg>
              <a href="mailto:john.doe@email.com" id="emailLink" style="color: white; text-decoration: none;">
                <span id="emailText">john.doe@email.com</span>
              </a>
            </div>

            <!-- Phone -->
            <div class="contact-detail">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
              </svg>
              <a href="tel:+15551234567" id="phoneLink" style="color: white; text-decoration: none;">
                <span id="phoneText">+1 (555) 123-4567</span>
              </a>
            </div>

            <!-- LinkedIn -->
            <div class="contact-detail">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path>
                <rect x="2" y="9" width="4" height="12"></rect>
                <circle cx="4" cy="4" r="2"></circle>
              </svg>
              <a href="https://linkedin.com/in/johndoe" id="linkedinLink" target="_blank" style="color: white; text-decoration: none;">linkedin.com/in/johndoe</a>
            </div>
          </div>

          <!-- Portfolio links section -->
          <div>
            <div class="portfolio-links" id="portfolioSection">
              <h3>PORTFOLIO</h3>
              <div class="portfolio-links-grid">
                <button class="portfolio-link" data-link-type="cert">Certifications</button>
                <button class="portfolio-link" data-link-type="edu">Education</button>
                <button class="portfolio-link" data-link-type="proj">Projects</button>
                <button class="portfolio-link" data-link-type="ref">References</button>
                <button class="portfolio-link" data-link-type="resume">Resume</button>
                <button class="portfolio-link" data-link-type="work">Work</button>
              </div>
            </div>
          </div>
        </div>

      </div><!-- /card-back -->

    </div>
  </div>

  <!-- Hint text for first-time users -->
  <div class="hint-text" id="hintText">Click card to see contact info</div>

  <!-- =================================
       HOME PANEL
       Shows user's own card and saved contacts
       ================================= -->
  <div class="home-panel" id="homePanel">
    <div class="panel-header">
      <div class="header-left">
        <button class="back-btn" onclick="closeHome()">←</button>
        <h2>My Collection</h2>
      </div>
    </div>

    <!-- Tab navigation -->
    <div class="tab-container">
      <div class="tab-ribbon" id="tabRibbon">
        <button class="tab active" onclick="switchTab('myCard')">My Card</button>
        <button class="tab" onclick="switchTab('contacts')">Saved Contacts</button>
      </div>
    </div>

    <div class="home-content">
      <!-- My Card tab content -->
      <div class="tab-content active" id="myCardTab">
        <div id="myCardSection"></div>
      </div>

      <!-- Saved Contacts tab content -->
      <div class="tab-content" id="contactsTab">
        <div class="cards-grid" id="contactsGrid"></div>
      </div>
    </div>
  </div>

  <!-- =================================
       SHARE PANEL
       QR code generation and link sharing
       ================================= -->
  <div class="share-panel" id="sharePanel">
    <div class="panel-header">
      <div class="header-left">
        <button class="back-btn" onclick="closeShare()">←</button>
        <h2>Share My Card</h2>
      </div>
    </div>

    <div class="share-content">
      <h3 style="margin-bottom: 10px;">Share via QR Code</h3>

      <p class="share-instructions">
        Others can scan this QR code to view and save your business card.
      </p>

      <div class="qr-code-container">
        <div id="qrcode"></div>

        <!-- Action buttons for QR code -->
        <div style="display:flex;gap:8px;justify-content:center;margin-top:12px;">
          <button class="action-btn" onclick="generateQRCode()">Regenerate</button>
          <button class="action-btn" onclick="copyShareLink()">Copy Link</button>
          <button class="action-btn" onclick="openShareLink()">Open Link</button>
        </div>
      </div>

      <!-- Warning messages for network issues -->
      <div id="qrWarnings" style="max-width:500px;margin:0 auto;text-align:center;color:#b91c1c;"></div>
    </div>
  </div>

  <!-- =================================
       SETTINGS PANEL
       Edit card information and preferences
       ================================= -->
  <div class="settings-panel" id="settingsPanel">
    <div class="panel-header">
      <div class="header-left">
        <button class="back-btn" onclick="closeSettings()">←</button>
        <h2>My Card Settings</h2>
      </div>
    </div>

    <div class="settings-content">
      <div class="section-title">PROFILE INFORMATION</div>

      <!-- Profile picture upload -->
      <div class="form-group">
        <label>Profile Picture</label>
        <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px; max-width: 100%">
          <!-- Preview of current/selected image -->
          <img
            id="previewPic"
            src="https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=400"
            alt="Preview"
            style="width: 80px; height: 80px; border-radius: 50%; object-fit: cover; border: 2px solid #d1d5db; flex-shrink: 0"
          />
          <div style="flex: 1; min-width: 0; max-width: 100%;">
            <input
              type="file"
              id="profilePicInput"
              accept="image/*"
              style="padding: 8px; border: 1px solid #d1d5db; border-radius: 8px; width: 100%; font-size: 14px; max-width: 100%; box-sizing: border-box;"
            />
            <p style="font-size: 12px; color: #6b7280; margin-top: 5px;">Upload a photo from your device</p>
          </div>
        </div>
      </div>

      <!-- Basic information fields -->
      <div class="form-group">
        <label>First Name (Required)</label>
        <input type="text" id="firstNameInput" value="John" placeholder="ex: John" />
      </div>

      <div class="form-group">
        <label>Last Name (Required)</label>
        <input type="text" id="lastNameInput" value="Doe" placeholder="ex: Doe" />
      </div>

      <div class="form-group">
        <label>Job Title</label>
        <input type="text" id="jobTitleInput" value="Student" placeholder="Student"/>
      </div>

      <div class="form-group">
        <label>Email (Required)</label>
        <input type="email" id="emailInput" value="john.doe@email.com" placeholder="ex: john.doe@email.com"/>
        <div class="email-error-box" id="emailErrorBox"></div>
      </div>

      <!-- Phone number with country code -->
      <div class="form-group">
        <label>Phone (Required)</label>
        <div class="phone-inputs">
          <select id="countryCodeSelect" aria-label="Country code">
            <option value="">Country code…</option>
            <option value="1">+1</option>
            <option value="44">+44</option>
            <option value="61">+61</option>
            <option value="81">+81</option>
            <option value="91">+91</option>
            <option value="353">+353</option>
          </select>
          <input
            id="localNumberInput"
            type="text"
            inputmode="numeric"
            pattern="\d*"
            maxlength="10"
            placeholder="10 digits"
          />
        </div>
        <div id="phoneError" class="email-error-box" style="display: none;"></div>
      </div>

      <div class="form-group">
        <label>LinkedIn URL</label>
        <input type="text" id="linkedinInput" value="https://linkedin.com/in/johndoe" placeholder="https://linkedin.com/in/yourname" />
      </div>

      <!-- Portfolio links section -->
      <div class="section-title">PORTFOLIO LINKS</div>

      <!-- Visibility toggles for portfolio items -->
      <div class="form-group">
        <label>Portfolio Items to Display</label>
        <p style="font-size: 12px; color: #6b7280; margin-bottom: 8px;">
          Select which portfolio items you want to show on your card
        </p>
        <div id="portfolioVisibilityOptions" style="display: flex; flex-direction: column; gap: 8px; padding: 12px; background: #f9fafb; border-radius: 8px; border: 1px solid #e5e7eb;">
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: normal;">
            <input type="checkbox" id="showCertifications" checked style="width: 18px; height: 18px; cursor: pointer;" />
            <span>Certifications</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: normal;">
            <input type="checkbox" id="showEducation" checked style="width: 18px; height: 18px; cursor: pointer;" />
            <span>Education</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: normal;">
            <input type="checkbox" id="showProjects" checked style="width: 18px; height: 18px; cursor: pointer;" />
            <span>Projects</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: normal;">
            <input type="checkbox" id="showReferences" checked style="width: 18px; height: 18px; cursor: pointer;" />
            <span>References</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: normal;">
            <input type="checkbox" id="showResume" checked style="width: 18px; height: 18px; cursor: pointer;" />
            <span>Resume</span>
          </label>
          <label style="display: flex; align-items: center; gap: 10px; cursor: pointer; font-weight: normal;">
            <input type="checkbox" id="showWork" checked style="width: 18px; height: 18px; cursor: pointer;" />
            <span>Work</span>
          </label>
        </div>
      </div>

      <!-- URL inputs for each portfolio item -->
      <div class="form-group">
        <label>Certifications Page URL</label>
        <input type="text" id="certPageInput" value="" placeholder="https://example.com/certifications" />
      </div>

      <div class="form-group">
        <label>Education Page URL</label>
        <input type="text" id="eduPageInput" value="" placeholder="https://example.com/education" />
      </div>

      <div class="form-group">
        <label>Projects Page URL</label>
        <input type="text" id="projPageInput" value="" placeholder="https://example.com/projects" />
      </div>

      <div class="form-group">
        <label>References Page URL</label>
        <input type="text" id="refPageInput" value="" placeholder="https://example.com/references" />
      </div>

      <div class="form-group">
        <label>Resume URL</label>
        <input type="text" id="resumePageInput" value="" placeholder="https://example.com/resume.pdf" />
      </div>

      <div class="form-group">
        <label>Work Experience URL</label>
        <input type="text" id="workPageInput" value="" placeholder="https://example.com/work" />
      </div>

      <!-- Customization section -->
      <div class="section-title">CUSTOMIZATION</div>

      <div class="form-group">
        <label>Card Color</label>
        <div class="color-input-group">
          <input type="color" id="cardColorPicker" value="#6366f1" />
          <input type="text" id="cardColorInput" value="#6366f1" />
        </div>
      </div>

      <div class="form-group">
        <label>Background Color</label>
        <div class="color-input-group">
          <input type="color" id="bgColorPicker" value="#6B46C1" />
          <input type="text" id="bgColorInput" value="#6B46C1" />
        </div>
      </div>

      <!-- Action buttons -->
      <button class="save-btn" onclick="saveSettings()">Save My Card</button>
      <button class="save-btn" onclick="resetToJohnDoe()" style="margin-top:12px;background:#ef4444">
        Reset Card to Default (John Doe)
      </button>
    </div>
  </div>

  <script>
    /* ==========================================================
       GLOBAL STATE VARIABLES
       Core application state management
       ========================================================== */

    // Card flip state
    let isFlipped = false;

    // Shared card viewing state
    let viewingSharedCard = false;  // true when viewing someone else's card via URL
    let sharedCardData = null;      // decoded data from ?card= URL parameter

    // Temporary storage for image uploads before saving
    let uploadedImageData = null;

    // Default card data (John Doe template)
    const DEFAULT_CARD = {
      firstName: 'John',
      lastName: 'Doe',
      jobTitle: 'Student',
      email: 'john.doe@email.com',
      phone: '+1 (555)-123-4567',
      phoneE164: '+15551234567',
      countryCode: '1',
      localNumber: '5551234567',
      linkedin: 'https://linkedin.com/in/johndoe',
      cardColor: '#6366f1',
      bgColor: '#6B46C1',
      profilePic: 'https://images.unsplash.com/photo-1472099645785-5658abf4ff4e?w=400',
      portfolioLinks: { cert: '', edu: '', proj: '', ref: '', resume: '', work: '' },
      portfolioVisibility: { cert: true, edu: true, proj: true, ref: true, resume: true, work: true },
      lastUpdated: ''
    };

    /* ==========================================================
       INITIALIZATION
       Check URL for shared card on page load
       ========================================================== */

    window.addEventListener('DOMContentLoaded', () => {
      checkForSharedCard();
    });

    /* ==========================================================
       DATA ENCODING/DECODING UTILITIES
       Convert objects to/from URL-safe base64 strings
       ========================================================== */

    /**
     * Encode an object to base64 for URL transmission
     * @param {Object} obj - Object to encode
     * @returns {string} Base64 encoded string
     */
    const encodeObj = (obj) => btoa(unescape(encodeURIComponent(JSON.stringify(obj))));

    /**
     * Decode a base64 string back to an object
     * @param {string} str - Base64 encoded string
     * @returns {Object} Decoded object
     */
    const decodeObj = (str) => JSON.parse(decodeURIComponent(escape(atob(str))));

    /* ==========================================================
       SHARED CARD DETECTION
       Check URL parameters for shared card data
       ========================================================== */

    /**
     * Check if URL contains ?card= parameter and load shared card
     * Called on page load to determine viewing mode
     */
    function checkForSharedCard() {
      const urlParams = new URLSearchParams(window.location.search);
      const cardData = urlParams.get('card');

      if (cardData) {
        // We're viewing a shared card
        viewingSharedCard = true;

        try {
          // Decode the card data from URL
          sharedCardData = decodeObj(cardData);
          applyCardData(sharedCardData);

          // Show save button for visitors
          const saveBtn = document.getElementById('saveContactBtn');
          if (saveBtn) saveBtn.classList.add('show');

          // Hide share button (doesn't make sense for visitors)
          const shareBtn = document.getElementById('shareButton');
          if (shareBtn) shareBtn.style.display = 'none';

          // Update hint text
          const hint = document.getElementById('hintText');
          if (hint) hint.textContent = 'Click card to see full details';
        } catch (error) {
          console.error('Invalid card data:', error);
          loadMyCard(); // Fall back to user's own card
        }
      } else {
        // No shared card, load user's own card
        loadMyCard();
      }
    }

    /* ==========================================================
       PERSONAL CARD LOADING
       Load user's saved card from localStorage
       ========================================================== */

    /**
     * Load the user's own business card from localStorage
     * Falls back to default card if none exists
     */
    function loadMyCard() {
      viewingSharedCard = false;

      const myCard = localStorage.getItem('myCard');

      if (myCard) {
        const cardData = JSON.parse(myCard);
        applyCardData(cardData);
      } else {
        // No saved card, use default template
        applyCardData(DEFAULT_CARD);
      }
    }

    /* ==========================================================
       SHARE PAYLOAD BUILDER
       Create sanitized object for sharing (excludes sensitive data)
       ========================================================== */

    /**
     * Build a share-safe version of card data
     * Excludes large file blobs and sensitive information
     * @param {Object} cardData - Full card data
     * @returns {Object} Sanitized card data for sharing
     */
    function buildShareObj(cardData) {
      return {
        firstName: cardData.firstName,
        lastName: cardData.lastName,
        jobTitle: cardData.jobTitle,
        email: cardData.email,
        phone: cardData.phone,
        phoneE164: cardData.phoneE164,
        linkedin: cardData.linkedin,
        cardColor: cardData.cardColor,
        bgColor: cardData.bgColor,
        profilePic: cardData.profilePic,
        portfolioLinks: cardData.portfolioLinks || {},
        portfolioVisibility: cardData.portfolioVisibility || { cert: true, edu: true, proj: true, ref: true, resume: true, work: true }
      };
    }

    /* ==========================================================
       CARD FLIP INTERACTION
       Toggle between front (photo) and back (info)
       ========================================================== */

    /**
     * Flip the business card to show opposite side
     * Triggered by clicking the card
     */
    function flipCard() {
      const card = document.getElementById('businessCard');
      const hint = document.getElementById('hintText');

      isFlipped = !isFlipped;

      if (isFlipped) {
        card.classList.add('flipped');
        hint.style.display = 'none';
      } else {
        card.classList.remove('flipped');
        hint.style.display = 'block';
      }
    }

    /* ==========================================================
       PORTFOLIO LINK HANDLER
       Open portfolio URLs when buttons are clicked
       ========================================================== */

    /**
     * Handle portfolio button clicks
     * Opens the configured URL or shows appropriate message
     * @param {Event} event - Click event
     * @param {string} type - Portfolio type (cert/edu/proj/ref)
     */
    function openLink(event, type) {
      event.stopPropagation(); // Prevent card flip

      const linkMap = {
        cert: 'Certifications',
        edu: 'Education',
        proj: 'Projects',
        ref: 'References',
        resume: 'Resume',
        work: 'Work Experience'
      };

      // Get URL from global portfolio links
      const url = window.portfolioLinks && window.portfolioLinks[type] 
        ? window.portfolioLinks[type].trim() 
        : '';

      if (url) {
        // Open URL in new tab
        const newWindow = window.open(url, '_blank');
        if (!newWindow) {
          alert('Pop-up blocked! Please allow pop-ups for this site.');
        }
      } else {
        // No URL configured
        const itemName = linkMap[type] || 'This item';

        if (viewingSharedCard) {
          alert(`No ${itemName} link available for this contact.`);
        } else {
          alert(`No link set for ${itemName}.\n\nAdd a URL in Settings to link to your portfolio.`);
        }
      }
    }

    /* ==========================================================
       PANEL NAVIGATION
       Open/close full-screen panels
       ========================================================== */

    /**
     * Open the home panel (My Card & Saved Contacts)
     */
    function openHome() {
      document.getElementById('homePanel').classList.add('active');
      loadMyCardSection();
      loadContacts();
    }

    /**
     * Close the home panel
     */
    function closeHome() {
      document.getElementById('homePanel').classList.remove('active');
    }

    /**
     * Open the share panel (QR code generation)
     */
    function openShare() {
      const myCard = localStorage.getItem('myCard');
      if (!myCard) {
        alert('Please create your card in Settings first!');
        return;
      }

      document.getElementById('sharePanel').classList.add('active');
      generateQRCode();
    }

    /**
     * Close the share panel
     */
    function closeShare() {
      document.getElementById('sharePanel').classList.remove('active');
    }

    /**
     * Open the settings panel
     */
    function openSettings() {
      document.getElementById('settingsPanel').classList.add('active');
    }

    /**
     * Close the settings panel
     */
    function closeSettings() {
      document.getElementById('settingsPanel').classList.remove('active');
    }

    /* ==========================================================
       HOME PANEL TAB SWITCHING
       Toggle between My Card and Saved Contacts tabs
       ========================================================== */

    /**
     * Switch active tab in home panel
     * @param {string} tabName - Name of tab to activate ('myCard' or 'contacts')
     */
    function switchTab(tabName) {
      // Update tab button states
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      event.target.classList.add('active');

      // Update tab content visibility
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById(tabName + 'Tab').classList.add('active');

      // Load appropriate content
      if (tabName === 'myCard') {
        loadMyCardSection();
      } else if (tabName === 'contacts') {
        loadContacts();
      }
    }

    /* ==========================================================
       COLOR UTILITY FUNCTIONS
       Helper functions for color validation and contrast
       ========================================================== */

    /**
     * Normalize hex color (convert 3-digit to 6-digit)
     * @param {string} hex - Hex color string
     * @returns {string|null} Normalized hex or null if invalid
     */
    function _hex(hex) {
      hex = (hex || '').trim().toLowerCase();
      if (!/^#([0-9a-f]{3}|[0-9a-f]{6})$/.test(hex)) return null;
      if (hex.length === 4) {
        // Convert #abc to #aabbcc
        hex = '#' + [hex[1], hex[2], hex[3]].map(c => c + c).join('');
      }
      return hex;
    }

    /**
     * Convert hex to RGB object
     * @param {string} hex - Hex color string
     * @returns {Object|null} RGB object {r, g, b} or null if invalid
     */
    function _rgb(hex) {
      hex = _hex(hex);
      if (!hex) return null;
      return {
        r: parseInt(hex.substr(1, 2), 16),
        g: parseInt(hex.substr(3, 2), 16),
        b: parseInt(hex.substr(5, 2), 16)
      };
    }

    /**
     * Calculate relative luminance of a color
     * @param {string} hex - Hex color string
     * @returns {number} Luminance value (0-1)
     */
    function _lum(hex) {
      const rgb = _rgb(hex);
      if (!rgb) return 1;
      
      // Convert to linear RGB and calculate luminance
      const linearize = (val) => {
        val /= 255;
        return val <= 0.03928 
          ? val / 12.92 
          : Math.pow((val + 0.055) / 1.055, 2.4);
      };
      
      const r = linearize(rgb.r);
      const g = linearize(rgb.g);
      const b = linearize(rgb.b);
      
      return 0.2126 * r + 0.7152 * g + 0.0722 * b;
    }

    /**
     * Determine best text color for given background
     * @param {string} bgHex - Background hex color
     * @returns {string} Either '#111827' (dark) or '#ffffff' (light)
     */
    function textOn(bgHex) {
      return _lum(bgHex) > 0.5 ? '#111827' : '#ffffff';
    }

    /**
     * Validate hex color format
     * @param {string} value - String to validate
     * @returns {boolean} True if valid hex color
     */
    function isHexColor(value) {
      return /^#([0-9a-fA-F]{3}|[0-9a-fA-F]{6})$/.test((value || '').trim());
    }

    /**
     * Pick valid color from text input or color picker
     * @param {string} textVal - Value from text input
     * @param {string} pickerVal - Value from color picker
     * @param {string} fallback - Fallback color
     * @returns {string} Valid hex color
     */
    function pickColor(textVal, pickerVal, fallback) {
      const trimmed = (textVal || '').trim();
      if (isHexColor(trimmed)) return trimmed.toLowerCase();
      if (isHexColor(pickerVal)) return pickerVal.toLowerCase();
      return fallback;
    }

    /**
     * Calculate contrasting text color (alternative method)
     * @param {string} hex - Background hex color
     * @returns {string} Contrasting text color
     */
    function contrastColor(hex) {
      let color = (hex || '#000').replace('#', '').trim();
      
      // Convert 3-digit to 6-digit
      if (color.length === 3) {
        color = color.split('').map(x => x + x).join('');
      }
      
      // Parse RGB values
      const r = parseInt(color.slice(0, 2), 16) || 0;
      const g = parseInt(color.slice(2, 4), 16) || 0;
      const b = parseInt(color.slice(4, 6), 16) || 0;
      
      // Calculate YIQ value
      const yiq = (r * 299 + g * 587 + b * 114) / 1000;
      
      return yiq >= 128 ? '#111827' : '#ffffff';
    }

    /* ==========================================================
       MY CARD SECTION
       Display user's own card in home panel
       ========================================================== */

    /**
     * Load and display user's card in home panel
     * Shows empty state if no card exists
     */
    function loadMyCardSection() {
      const myCard = localStorage.getItem('myCard');
      const section = document.getElementById('myCardSection');

      if (!myCard) {
        // Show empty state with create button
        section.innerHTML = `
          <div class="empty-state">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
              <line x1="1" y1="10" x2="23" y2="10"></line>
            </svg>
            <h3>Create Your Business Card</h3>
            <p>Set up your digital business card to share with others</p>
            <button class="save-btn" onclick="openSettings()" style="max-width:200px;margin:20px auto 0;">Create My Card</button>
          </div>`;
        return;
      }

      const card = JSON.parse(myCard);

      // Calculate colors for styling
      const accent = card.cardColor || '#6366f1';
      const text = textOn(accent);
      const chipBg = text === '#ffffff' 
        ? 'rgba(255,255,255,0.2)' 
        : 'rgba(0,0,0,0.08)';
      const chipBorder = text === '#ffffff' ? '#ffffff' : 'rgba(0,0,0,0.2)';
      const editText = _lum(accent) > 0.85 ? '#111827' : accent;
      const borderColor = _lum(accent) < 0.45 ? '#ffffff' : '#111827';

      // Build name line with optional job title
      const nameLine = (card.jobTitle && card.jobTitle.trim())
        ? `${card.firstName} ${card.lastName} - ${card.jobTitle}`
        : `${card.firstName} ${card.lastName}`;

      // Render card preview
      section.innerHTML = `
        <div class="my-card-section" style="background:${accent};color:${text};border:2px solid ${borderColor}">
          <h3 style="color:${text}">My Business Card</h3>

          <div class="my-card-preview">
            <img src="${card.profilePic}" alt="${card.firstName}" class="my-card-pic">

            <div class="my-card-details">
              <h4 style="color:${text}">${nameLine}</h4>
              <p style="color:${text}">${card.email}</p>
              <p style="color:${text}">${card.phone || ''}</p>
            </div>
          </div>

          <div style="display:flex;gap:10px;margin-top:20px;">
            <button class="action-btn" onclick="closeHome(); openSettings();" 
              style="background:#fff;color:${editText};font-weight:600;border:1px solid ${chipBorder}">
              Edit Card
            </button>

            <button class="action-btn" onclick="closeHome(); openShare();" 
              style="background:${chipBg};color:${text};border:1px solid ${chipBorder};font-weight:600">
              Share Card
            </button>
          </div>
        </div>`;
    }

    /* ==========================================================
       SAVED CONTACTS MANAGEMENT
       Display, save, view, and delete saved contacts
       ========================================================== */

    /**
     * Load and display all saved contacts
     * Shows empty state if no contacts saved
     */
    function loadContacts() {
      const contacts = JSON.parse(localStorage.getItem('savedContacts') || '[]');
      const grid = document.getElementById('contactsGrid');

      if (contacts.length === 0) {
        // Show empty state
        grid.classList.add('is-empty');
        grid.innerHTML = `
          <div class="empty-state">
            <svg width="80" height="80" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <h3>No contacts yet</h3>
            <p>When someone shares their card with you, save it here</p>
          </div>`;
        return;
      }

      grid.classList.remove('is-empty');

      // Render contact cards
      grid.innerHTML = contacts.map((contact, index) => `
        <div class="saved-card">
          <div class="saved-card-header">
            <img src="${contact.profilePic}" alt="${contact.firstName}" class="saved-card-pic">
            <div class="saved-card-info">
              <h3>${contact.firstName} ${contact.lastName}</h3>
              <p>${contact.email}</p>
            </div>
          </div>

          <div class="saved-card-actions">
            <button class="action-btn" onclick="viewContact(${index})">View</button>
            <button class="action-btn delete-btn" onclick="deleteContact(${index})">Delete</button>
          </div>
        </div>
      `).join('');
    }

    /**
     * Save currently viewed shared card to contacts
     * Prevents duplicate saves
     */
    function saveContact() {
      if (!sharedCardData) return;

      let contacts = JSON.parse(localStorage.getItem('savedContacts') || '[]');

      // Check for duplicates
      const exists = contacts.some(c =>
        c.firstName === sharedCardData.firstName &&
        c.lastName === sharedCardData.lastName &&
        c.email === sharedCardData.email
      );

      if (exists) {
        alert('This contact is already in your collection!');
        return;
      }

      // Add to contacts with timestamp
      contacts.push({
        ...sharedCardData,
        savedAt: new Date().toISOString()
      });

      localStorage.setItem('savedContacts', JSON.stringify(contacts));

      alert(`${sharedCardData.firstName} ${sharedCardData.lastName}'s card saved to your contacts!`);
      document.getElementById('saveContactBtn').classList.remove('show');
    }

    /**
     * View a saved contact's card
     * @param {number} index - Index of contact in saved contacts array
     */
    function viewContact(index) {
      const contacts = JSON.parse(localStorage.getItem('savedContacts') || '[]');
      const contact = contacts[index];

      if (contact) {
        applyCardData(contact);
        closeHome();
      }
    }

    /**
     * Delete a saved contact
     * @param {number} index - Index of contact to delete
     */
    function deleteContact(index) {
      if (!confirm('Remove this contact?')) return;

      let contacts = JSON.parse(localStorage.getItem('savedContacts') || '[]');
      contacts.splice(index, 1);
      localStorage.setItem('savedContacts', JSON.stringify(contacts));

      loadContacts();
    }

    /* ==========================================================
       INPUT VALIDATION & FORMATTING
       Real-time validation for name, email, and phone inputs
       ========================================================== */

    /**
     * Initialize name input filters
     * Allows letters, hyphens, apostrophes, and spaces
     */
    setTimeout(() => {
      const firstNameInput = document.getElementById("firstNameInput");
      const lastNameInput = document.getElementById("lastNameInput");

      if (firstNameInput) {
        firstNameInput.addEventListener("input", () => {
          // Allow only valid name characters
          firstNameInput.value = firstNameInput.value.replace(/[^A-Za-z'-]/g, "");
        });
      }

      if (lastNameInput) {
        lastNameInput.addEventListener("input", () => {
          // Allow spaces in last names (for multi-part names)
          lastNameInput.value = lastNameInput.value.replace(/[^A-Za-z' -]/g, "");
        });
      }
    }, 300);

    /**
     * Format name with proper capitalization
     * Handles hyphenated names, apostrophes, and particles (de, van, etc.)
     * @param {string} name - Name to format
     * @param {boolean} isLastName - Whether this is a last name (allows spaces)
     * @returns {string|null} Formatted name or null if invalid
     */
    function formatName(name, isLastName = false) {
      name = name.trim();

      // Normalize spaces
      if (isLastName) {
        name = name.replace(/\s+/g, " ");
      } else {
        name = name.replace(/\s+/g, "");
      }

      // Validate characters
      const allowedRegex = isLastName ? /^[A-Za-z' -]+$/ : /^[A-Za-z'-]+$/;
      if (!allowedRegex.test(name)) return null;

      // Check length
      if (name.length < 1 || name.length > 30) return null;

      // Name particles that should stay lowercase
      const particles = ["de", "del", "la", "las", "los", "da", "das", "dos", 
                         "van", "von", "der", "den", "le", "du", "di"];

      /**
       * Capitalize a word appropriately
       * @param {string} word - Word to capitalize
       * @returns {string} Properly capitalized word
       */
      function capitalize(word) {
        const lower = word.toLowerCase();

        // Keep particles lowercase
        if (particles.includes(lower)) return lower;

        // Handle hyphenated parts
        if (lower.includes("-")) {
          return lower.split("-")
            .map(part => part.charAt(0).toUpperCase() + part.slice(1))
            .join("-");
        }

        // Handle apostrophes (O'Neil)
        if (lower.includes("'")) {
          return lower.split("'")
            .map(part => part.charAt(0).toUpperCase() + part.slice(1))
            .join("'");
        }

        // Standard capitalization
        return lower.charAt(0).toUpperCase() + lower.slice(1);
      }

      // Split into words and capitalize each
      const parts = isLastName ? name.split(" ") : [name];
      return parts.map(capitalize).join(" ");
    }

    /**
     * Email input filter - allows only valid email characters
     */
    document.getElementById("emailInput").addEventListener("input", function(event) {
      let value = event.target.value.toLowerCase();

      // Remove invalid characters
      value = value.replace(/[^a-z0-9@._-]/g, "");
      value = value.replace(/\s+/g, "");

      // Clean up domain part (no numbers in domain)
      if (value.includes("@")) {
        const atIndex = value.indexOf("@");
        let localPart = value.slice(0, atIndex);
        let domainPart = value.slice(atIndex + 1).replace(/[0-9]/g, "");
        value = localPart + "@" + domainPart;
      }

      event.target.value = value;
    });

    /**
     * Validate email format and return list of errors
     * @param {string} email - Email to validate
     * @returns {Array<string>} Array of error messages
     */
    function getEmailErrors(email) {
      const trimmed = email.trim().toLowerCase();
      let errors = [];

      // Length check
      if (trimmed.length < 5 || trimmed.length > 80) {
        errors.push("Email length must be between 5–80 characters.");
      }

      // @ symbol check
      const atCount = (trimmed.match(/@/g) || []).length;
      if (atCount !== 1) {
        errors.push("Must contain exactly one '@' symbol.");
      }

      // Basic format checks
      if (trimmed.includes("..")) errors.push("Email cannot contain consecutive dots.");
      if (trimmed.startsWith(".")) errors.push("Email cannot start with a dot.");
      if (trimmed.endsWith(".")) errors.push("Email cannot end with a dot.");
      if (trimmed.startsWith("-")) errors.push("Email cannot start with a dash.");

      // Domain validation
      if (atCount === 1) {
        const [localPart, domainPart] = trimmed.split("@");

        if (!localPart.length) errors.push("Missing text before '@'.");
        if (!domainPart.includes(".")) errors.push("Domain must contain a dot.");
        if (domainPart.includes("..")) errors.push("Domain cannot contain consecutive dots.");
        if (domainPart.startsWith(".")) errors.push("Domain cannot start with a dot.");
        if (domainPart.endsWith(".")) errors.push("Domain cannot end with a dot.");
        if (/[0-9]/.test(domainPart)) errors.push("Domain cannot contain numbers.");

        // TLD validation
        const tld = domainPart.split(".").pop();
        if ((tld || '').length < 2) {
          errors.push("Top-level domain must be at least 2 letters.");
        }
      }

      return errors;
    }

    /**
     * Live email validation feedback
     */
    const emailInput = document.getElementById("emailInput");
    const emailErrorBox = document.getElementById("emailErrorBox");

    emailInput.addEventListener("input", () => {
      const value = emailInput.value.trim().toLowerCase();
      const errors = getEmailErrors(value);

      if (errors.length === 0) {
        emailErrorBox.style.display = "none";
        emailErrorBox.innerHTML = "";
      } else {
        emailErrorBox.style.display = "block";
        emailErrorBox.innerHTML = "⚠ Email is invalid:<br>• " + errors.join("<br>• ");
      }
    });

    /* ==========================================================
       PHONE NUMBER HANDLING
       Format and validate phone numbers with country codes
       ========================================================== */

    // Allowed country codes
    const ALLOWED_COUNTRY_CODES = ['1', '44', '61', '81', '91', '353'];

    /**
     * Initialize phone number input filter (digits only, max 10)
     */
    (function initPhoneFilter() {
      const localInput = document.getElementById('localNumberInput');
      if (!localInput) return;

      const filter = () => {
        // Remove non-digits and limit to 10
        let value = localInput.value.replace(/\D+/g, '');
        if (value.length > 10) value = value.slice(0, 10);
        localInput.value = value;
      };

      ['input', 'paste', 'change', 'blur'].forEach(evt => {
        localInput.addEventListener(evt, filter);
      });
    })();

    /**
     * Format phone number for display and E.164
     * @param {string} countryCode - Country code
     * @param {string} local - 10-digit local number
     * @returns {Object} {pretty, e164} formatted phone numbers
     */
    function formatPhone(countryCode, local) {
      const pretty = `+${countryCode} (${local.slice(0, 3)}) ${local.slice(3, 6)}-${local.slice(6)}`;
      const e164 = `+${countryCode}${local}`;
      return { pretty, e164 };
    }

    /**
     * Show or hide phone error message
     * @param {string} message - Error message to display (empty to hide)
     */
    function showPhoneError(message) {
      const errorBox = document.getElementById('phoneError');
      if (!errorBox) return;

      if (message) {
        errorBox.style.display = 'block';
        errorBox.innerHTML = message;
      } else {
        errorBox.style.display = 'none';
        errorBox.innerHTML = '';
      }
    }

    /**
     * Parse pretty-formatted phone number back to components
     * @param {string} prettyPhone - Formatted phone like "+1 (555) 123-4567"
     * @returns {Object|null} {cc, local, prettyLocal} or null if invalid
     */
    function parsePrettyPhone10(prettyPhone) {
      const match = (prettyPhone || '').match(/^\+?(\d{1,3})\s*\((\d{3})\)\s*(\d{3})-(\d{4})$/);
      if (!match) return null;

      const localNumber = match[2] + match[3] + match[4]; // 10 digits
      const prettyLocal = `(${match[2]})-${match[3]}-${match[4]}`;

      return {
        cc: match[1],
        local: localNumber,
        prettyLocal: prettyLocal
      };
    }

    /* ==========================================================
       URL VALIDATION & FIXING
       Ensure URLs have proper protocol
       ========================================================== */

    /**
     * Add https:// to URL if missing protocol
     * @param {string} url - URL to fix
     * @returns {string} URL with protocol
     */
    function fixUrl(url) {
      if (!url || !url.trim()) return '';
      
      url = url.trim();
      
      // Already has protocol
      if (/^https?:\/\//i.test(url)) {
        return url;
      }
      
      // Add https://
      return 'https://' + url;
    }

    /* ==========================================================
       SAVE SETTINGS
       Validate and save all card settings to localStorage
       ========================================================== */

    /**
     * Validate and save all card settings
     * Performs comprehensive validation before saving
     */
    function saveSettings() {
      // Validate and format names
      const firstName = formatName(document.getElementById('firstNameInput').value, false);
      const lastName = formatName(document.getElementById('lastNameInput').value, true);
      
      if (!firstName) {
        alert("Invalid first name.");
        return;
      }
      if (!lastName) {
        alert("Invalid last name.");
        return;
      }

      // Validate email
      const emailErrors = getEmailErrors(document.getElementById('emailInput').value);
      if (emailErrors.length) {
        alert("Email invalid:\n- " + emailErrors.join("\n- "));
        return;
      }

      // Get form values
      const email = document.getElementById('emailInput').value.trim().toLowerCase();
      const linkedin = fixUrl(document.getElementById('linkedinInput').value);
      const jobTitle = document.getElementById('jobTitleInput').value;

      // Validate phone number
      const countryCode = (document.getElementById('countryCodeSelect').value || '').trim();
      const localNumber = (document.getElementById('localNumberInput').value || '').trim();
      
      if (!countryCode) {
        showPhoneError('Please choose a country code.');
        return;
      }
      if (!ALLOWED_COUNTRY_CODES.includes(countryCode)) {
        showPhoneError('Country code is not allowed.');
        return;
      }
      if (localNumber.length !== 10) {
        showPhoneError('Phone number must be exactly 10 digits.');
        return;
      }
      if (!/^\d{10}$/.test(localNumber)) {
        showPhoneError('Phone number can contain digits only.');
        return;
      }
      showPhoneError('');

      // Get color values
      const cardColor = pickColor(
        document.getElementById('cardColorInput').value,
        document.getElementById('cardColorPicker').value,
        '#6366f1'
      );
      const bgColor = pickColor(
        document.getElementById('bgColorInput').value,
        document.getElementById('bgColorPicker').value,
        '#6B46C1'
      );

      // Get portfolio URLs and fix formatting
      const certPage = fixUrl(document.getElementById('certPageInput').value);
      const eduPage = fixUrl(document.getElementById('eduPageInput').value);
      const projPage = fixUrl(document.getElementById('projPageInput').value);
      const refPage = fixUrl(document.getElementById('refPageInput').value);
      const resumePage = fixUrl(document.getElementById('resumePageInput').value);  
      const workPage = fixUrl(document.getElementById('workPageInput').value);      

      // Get portfolio visibility settings
      const showCert = document.getElementById('showCertifications').checked;
      const showEdu = document.getElementById('showEducation').checked;
      const showProj = document.getElementById('showProjects').checked;
      const showRef = document.getElementById('showReferences').checked;
      const showResume = document.getElementById('showResume').checked;             
      const showWork = document.getElementById('showWork').checked;                 

      // Get profile picture (uploaded or existing)
      let profilePicData = uploadedImageData || document.getElementById('profilePic').src;
      
      // Format phone number
      const formattedPhone = formatPhone(countryCode, localNumber);

      // Build card data object
      const cardData = {
        firstName,
        lastName,
        jobTitle,
        email,
        phone: formattedPhone.pretty,
        phoneE164: formattedPhone.e164,
        countryCode: countryCode,
        localNumber: localNumber,
        linkedin,
        cardColor,
        bgColor,
        profilePic: profilePicData,
        portfolioLinks: {
          cert: certPage,
          edu: eduPage,
          proj: projPage,
          ref: refPage,
          resume: resumePage,
          work: workPage
        },
        portfolioVisibility: {
          cert: showCert,
          edu: showEdu,
          proj: showProj,
          ref: showRef,
          resume: showResume,
          work: showWork
        },
        lastUpdated: new Date().toISOString()
      };

      // Save to localStorage
      try {
        localStorage.setItem('myCard', JSON.stringify(cardData));
      } catch (error) {
        console.error('Failed to save card:', error);
        alert('Could not save your card (storage full). Try reducing image size.');
        return;
      }

      // Apply to current card view
      applyCardData(cardData);
      loadMyCardSection();

      // Clear temporary upload data
      uploadedImageData = null;

      closeSettings();
      alert('Your card has been saved!');
    }

    /* ==========================================================
       QR CODE GENERATION
       Generate shareable QR code using quickchart.io
       ========================================================== */

    /**
     * Generate QR code for card sharing
     * Creates shareable URL and renders QR code image
     */
    function generateQRCode() {
      const myCard = localStorage.getItem('myCard');
      const qrContainer = document.getElementById('qrcode');
      const warningsDiv = document.getElementById('qrWarnings');

      if (!myCard || !qrContainer) return;

      // Build share object (exclude large data)
      const rawCard = JSON.parse(myCard);
      const shareObj = buildShareObj(rawCard);
      const encodedCard = encodeObj(shareObj);

      // Build share URL
      let baseUrl = `${location.origin}${location.pathname}`;
      
      // Normalize URL (remove existing query params)
      try {
        const url = new URL(baseUrl, window.location.href);
        url.search = '';
        baseUrl = url.href;
      } catch (error) {
        // If URL parsing fails, use as-is
      }

      const shareUrl = `${baseUrl}${baseUrl.includes('?') ? '&' : '?'}card=${encodedCard}`;

      // Clear previous content
      qrContainer.innerHTML = '';
      if (warningsDiv) warningsDiv.innerHTML = '';

      // Check for network accessibility issues
      try {
        const urlTest = new URL(baseUrl, window.location.href);
        const protocol = (urlTest.protocol || '').replace(':', '');
        const hostname = (urlTest.hostname || '').toLowerCase();

        if (protocol === 'file') {
          if (warningsDiv) {
            warningsDiv.innerHTML = 
              'This is a local file (<code>file://</code>). Phones cannot open that. ' +
              'Run a web server and use your network URL instead.';
          }
        } else if (hostname === 'localhost' || hostname === '127.0.0.1') {
          if (warningsDiv) {
            warningsDiv.innerHTML = 
              'The QR points to <code>localhost</code>. Other devices cannot reach it. ' +
              'Use your network IP (e.g., <code>http://192.168.1.23:5500/yourfile.html</code>).';
          }
        }
      } catch (error) {
        // Ignore URL parsing errors
      }

      // Check if payload is too large for QR code
      if (encodedCard.length > 2000) {
        qrContainer.innerHTML = `
          <div style="padding:20px;text-align:center;">
            <p style="color:#6b7280;margin-bottom:12px;">
              Link is too long for QR code. Use copy/open instead:
            </p>
            <div style="background:#f3f4f6;padding:12px;border-radius:8px;word-break:break-all;
                        font-size:11px;font-family:monospace;margin-bottom:12px;">
              ${shareUrl}
            </div>
          </div>`;
        return;
      }

      // Generate QR code using quickchart.io
      const qrImage = document.createElement('img');
      qrImage.style.maxWidth = '100%';
      qrImage.style.height = 'auto';
      qrImage.crossOrigin = 'anonymous';

      let imageLoaded = false;
      
      // Timeout fallback (5 seconds)
      const timeout = setTimeout(() => {
        if (!imageLoaded) {
          qrContainer.innerHTML = `
            <div style="padding:20px;text-align:center;">
              <p style="color:#6b7280;margin-bottom:12px;">QR generation timed out.</p>
              <div style="background:#f3f4f6;padding:12px;border-radius:8px;word-break:break-all;
                          font-size:11px;font-family:monospace;">
                ${shareUrl}
              </div>
            </div>`;
        }
      }, 5000);

      qrImage.onload = function() {
        imageLoaded = true;
        clearTimeout(timeout);
        qrContainer.innerHTML = '';
        qrContainer.appendChild(qrImage);
      };

      qrImage.onerror = function() {
        imageLoaded = true;
        clearTimeout(timeout);
        qrContainer.innerHTML = `
          <div style="padding:20px;text-align:center;">
            <p style="color:#6b7280;margin-bottom:12px;">QR image failed to load.</p>
            <div style="background:#f3f4f6;padding:12px;border-radius:8px;word-break:break-all;
                        font-size:11px;font-family:monospace;">
              ${shareUrl}
            </div>
          </div>`;
      };

      // Set QR code source
      qrImage.src = `https://quickchart.io/qr?text=${encodeURIComponent(shareUrl)}&size=256&dark=000000&light=ffffff`;
    }

    /**
     * Build shareable URL from current card data
     * @returns {string} Complete shareable URL
     */
    function buildShareUrlFromUI() {
      const myCard = localStorage.getItem('myCard');
      if (!myCard) return `${location.origin}${location.pathname}`;

      const rawCard = JSON.parse(myCard);
      const shareObj = buildShareObj(rawCard);
      const encodedCard = encodeObj(shareObj);

      let baseUrl = `${location.origin}${location.pathname}`;

      try {
        const url = new URL(baseUrl, window.location.href);
        url.search = '';
        baseUrl = url.href;
      } catch (error) {
        // Use baseUrl as-is
      }

      return `${baseUrl}${baseUrl.includes('?') ? '&' : '?'}card=${encodedCard}`;
    }

    /**
     * Copy share link to clipboard
     */
    function copyShareLink() {
      const url = buildShareUrlFromUI();
      navigator.clipboard.writeText(url)
        .then(() => alert('Link copied to clipboard!'))
        .catch(() => alert('Copy failed. Please select and copy manually.'));
    }

    /**
     * Open share link in new tab (for testing)
     */
    function openShareLink() {
      const url = buildShareUrlFromUI();
      window.open(url, '_blank');
    }

    /* ==========================================================
       IMAGE UPLOAD HANDLER
       Handle profile picture uploads
       ========================================================== */

    /**
     * Initialize profile picture upload handler
     */
    document.getElementById('profilePicInput').addEventListener('change', function(event) {
      if (event.target.files && event.target.files[0]) {
        const fileReader = new FileReader();

        fileReader.onload = function(loadEvent) {
          // Store as base64 data URL
          uploadedImageData = loadEvent.target.result;

          // Update all image previews
          document.getElementById('previewPic').src = uploadedImageData;
          document.getElementById('profilePic').src = uploadedImageData;
          document.getElementById('profilePicSmall').src = uploadedImageData;
        };

        fileReader.readAsDataURL(event.target.files[0]);
      }
    });

    /* ==========================================================
       COLOR PICKER SYNC
       Keep color picker and text input synchronized
       ========================================================== */

    // Card color sync
    document.getElementById('cardColorPicker').addEventListener('input', (event) => {
      document.getElementById('cardColorInput').value = event.target.value;
    });

    document.getElementById('cardColorInput').addEventListener('input', (event) => {
      document.getElementById('cardColorPicker').value = event.target.value;
    });

    // Background color sync
    document.getElementById('bgColorPicker').addEventListener('input', (event) => {
      document.getElementById('bgColorInput').value = event.target.value;
    });

    document.getElementById('bgColorInput').addEventListener('input', (event) => {
      document.getElementById('bgColorPicker').value = event.target.value;
    });

    /* ==========================================================
       CARD PARALLAX EFFECT
       3D tilt effect on mouse movement / touch
       ========================================================== */

    const cardContainer = document.querySelector('.card-container');

    if (cardContainer) {
      // Mouse move parallax (desktop)
      cardContainer.addEventListener('mousemove', (event) => {
        if (window.innerWidth > 768) {
          const rect = cardContainer.getBoundingClientRect();
          const x = event.clientX - rect.left;
          const y = event.clientY - rect.top;

          const centerX = rect.width / 2;
          const centerY = rect.height / 2;

          // Calculate rotation based on mouse position
          const rotateX = (y - centerY) / 10;
          const rotateY = (centerX - x) / 10;

          cardContainer.style.transform = 
            `perspective(1500px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
        }
      });

      // Reset on mouse leave
      cardContainer.addEventListener('mouseleave', () => {
        cardContainer.style.transform = 
          'perspective(1500px) rotateX(0deg) rotateY(0deg)';
      });

      // Touch parallax (mobile)
      cardContainer.addEventListener('touchmove', (event) => {
        const touch = event.touches[0];
        const rect = cardContainer.getBoundingClientRect();

        const x = touch.clientX - rect.left;
        const y = touch.clientY - rect.top;

        const centerX = rect.width / 2;
        const centerY = rect.height / 2;

        // Gentler rotation for touch
        const rotateX = (y - centerY) / 15;
        const rotateY = (centerX - x) / 15;

        cardContainer.style.transform = 
          `perspective(1500px) rotateX(${rotateX}deg) rotateY(${rotateY}deg)`;
      });

      // Reset on touch end
      cardContainer.addEventListener('touchend', () => {
        cardContainer.style.transform = 
          'perspective(1500px) rotateX(0deg) rotateY(0deg)';
      });
    }

    /**
     * Prevent accidental card flip when clicking interactive elements
     * Stops propagation for links, buttons, inputs, etc.
     */
    (function preventAccidentalFlip() {
      const cardRoot = document.getElementById('businessCard');
      if (!cardRoot) return;

      // Elements that should not trigger card flip
      const NON_FLIP_SELECTORS = 'a, button, input, select, textarea, [data-no-flip], .portfolio-link';

      // Use capture phase to intercept before flip handler
      ['click', 'touchstart'].forEach(eventType => {
        cardRoot.addEventListener(eventType, (event) => {
          if (event.target.closest(NON_FLIP_SELECTORS)) {
            event.stopPropagation();
          }
        }, { capture: true });
      });
    })();

    /* ==========================================================
       APPLY CARD DATA
       Update UI with card information
       ========================================================== */

    /**
     * Apply card data to all UI elements
     * Updates the business card display and settings form
     * @param {Object} cardData - Card data to apply
     */
    function applyCardData(cardData) {
      // Update name and job title
      document.getElementById('fullName').textContent = 
        `${cardData.firstName} ${cardData.lastName}`;
      document.getElementById('jobTitle').textContent = cardData.jobTitle || '';

      // Update LinkedIn
      const linkedinLink = document.getElementById('linkedinLink');
      linkedinLink.href = cardData.linkedin || '#';
      linkedinLink.textContent = (cardData.linkedin || '')
        .replace('https://', '')
        .replace('http://', '');

      // Parse and format phone number
      let prettyPhone = cardData.phone;
      let e164Phone = cardData.phoneE164;

      if (!e164Phone && cardData.phone) {
        const parsed = parsePrettyPhone10(cardData.phone);
        if (parsed) {
          const formatted = formatPhone(parsed.cc, parsed.local);
          prettyPhone = formatted.pretty;
          e164Phone = formatted.e164;
        }
      }

      // Update phone display
      document.getElementById('phoneText').textContent = prettyPhone || '';
      document.getElementById('phoneLink').href = e164Phone ? 'tel:' + e164Phone : '#';

      // Update email
      document.getElementById('emailText').textContent = cardData.email;
      document.getElementById('emailLink').href = 'mailto:' + cardData.email;

      // Update images
      document.getElementById('profilePic').src = cardData.profilePic;
      document.getElementById('profilePicSmall').src = cardData.profilePic;
      document.getElementById('previewPic').src = cardData.profilePic;

      // Update card colors
      const cardColor = cardData.cardColor;
      document.getElementById('cardFront').style.background = 
        `linear-gradient(135deg, ${cardColor} 0%, ${cardColor} 50%, ${cardColor} 100%)`;
      document.getElementById('cardBack').style.background = cardColor;

      // Calculate text colors for contrast
      const textColor = contrastColor(cardColor);
      const chipBg = textColor === '#ffffff' 
        ? 'rgba(255,255,255,0.2)' 
        : 'rgba(0,0,0,0.15)';
      const chipBgHover = textColor === '#ffffff' 
        ? 'rgba(255,255,255,0.3)' 
        : 'rgba(0,0,0,0.25)';

      // Apply CSS custom properties for dynamic styling
      const cardBackEl = document.getElementById('cardBack');
      cardBackEl.style.setProperty('--card-text', textColor);
      cardBackEl.style.setProperty('--card-chip-bg', chipBg);
      cardBackEl.style.setProperty('--card-chip-bg-hover', chipBgHover);

      // Update background gradient
      document.body.style.background = 
        `radial-gradient(circle at center, white 0%, ${cardData.bgColor} 100%)`;

      // Populate settings form (only for own card, not shared)
      if (!viewingSharedCard) {
        document.getElementById('firstNameInput').value = cardData.firstName;
        document.getElementById('lastNameInput').value = cardData.lastName;
        document.getElementById('jobTitleInput').value = cardData.jobTitle || '';
        document.getElementById('emailInput').value = cardData.email;
        document.getElementById('linkedinInput').value = cardData.linkedin || '';
        document.getElementById('cardColorInput').value = cardData.cardColor;
        document.getElementById('cardColorPicker').value = cardData.cardColor;
        document.getElementById('bgColorInput').value = cardData.bgColor;
        document.getElementById('bgColorPicker').value = cardData.bgColor;

        // Portfolio URLs
        const portfolioLinks = cardData.portfolioLinks || {};
        document.getElementById('certPageInput').value = portfolioLinks.cert || '';
        document.getElementById('eduPageInput').value = portfolioLinks.edu || '';
        document.getElementById('projPageInput').value = portfolioLinks.proj || '';
        document.getElementById('refPageInput').value = portfolioLinks.ref || '';
        document.getElementById('resumePageInput').value = portfolioLinks.resume || '';  
        document.getElementById('workPageInput').value = portfolioLinks.work || '';       

        // Phone number fields
        const countryCodeSelect = document.getElementById('countryCodeSelect');
        const localNumberInput = document.getElementById('localNumberInput');

        let countryCode = cardData.countryCode;
        let localNumber = cardData.localNumber;

        // Try to parse from pretty phone if not available
        if ((!countryCode || !localNumber) && cardData.phone) {
          const parsed = parsePrettyPhone10(cardData.phone);
          if (parsed) {
            countryCode = parsed.cc;
            localNumber = parsed.local;
          }
        }

        // Set values if valid
        countryCodeSelect.value = (countryCode && ALLOWED_COUNTRY_CODES.includes(countryCode)) 
          ? countryCode 
          : '';
        localNumberInput.value = localNumber 
          ? localNumber.replace(/\D+/g, '').slice(0, 10) 
          : '';

        // Portfolio visibility checkboxes
        const visibility = cardData.portfolioVisibility || { 
          cert: true, edu: true, proj: true, ref: true, resume: true, work: true  
        };
        document.getElementById('showCertifications').checked = visibility.cert !== false;
        document.getElementById('showEducation').checked = visibility.edu !== false;
        document.getElementById('showProjects').checked = visibility.proj !== false;
        document.getElementById('showReferences').checked = visibility.ref !== false;
        document.getElementById('showResume').checked = visibility.resume !== false;     
        document.getElementById('showWork').checked = visibility.work !== false;         
      }

      // Store portfolio links globally for button handlers
      window.portfolioLinks = cardData.portfolioLinks;

      // Render portfolio section with visibility settings
      renderPortfolioSection(cardData);
    }

    /* ==========================================================
       PORTFOLIO SECTION RENDERING
       Dynamically render portfolio buttons based on visibility
       ========================================================== */

    /**
     * Render portfolio section with only visible items
     * Dynamically adjusts grid layout based on number of items
     * @param {Object} cardData - Card data with portfolio settings
     */
    function renderPortfolioSection(cardData) {
      const visibility = cardData.portfolioVisibility || { 
        cert: true, edu: true, proj: true, ref: true, resume: true, work: true
      };

      // Build array of visible portfolio items
      const visibleItems = [];
      if (visibility.cert !== false) {
        visibleItems.push({
          type: 'cert',
          label: 'Certifications'
        });
      }
      if (visibility.edu !== false) {
        visibleItems.push({
          type: 'edu',
          label: 'Education'
        });
      }
      if (visibility.proj !== false) {
        visibleItems.push({
          type: 'proj',
          label: 'Projects'
        });
      }
      if (visibility.ref !== false) {
        visibleItems.push({
          type: 'ref',
          label: 'References'
        });
      }
      if (visibility.resume !== false) {
        visibleItems.push({
          type: 'resume',
          label: 'Resume'
        });
      }
      if (visibility.work !== false) {
        visibleItems.push({
          type: 'work',
          label: 'Work'
        });
      }

      const portfolioSection = document.querySelector('.portfolio-links');
      if (!portfolioSection) return;

      // Hide section if no items
      if (visibleItems.length === 0) {
        portfolioSection.style.display = 'none';
        return;
      }

      // Determine grid layout based on item count
      let gridStyle = 'margin: 0 auto; display: grid; gap: 6px;';
      let gridHtml = '';

      switch (visibleItems.length) {
        case 1:
          gridStyle += 'grid-template-columns: 1fr; max-width: 140px;';
          gridHtml = visibleItems.map(item => 
            `<button class="portfolio-link" data-link-type="${item.type}">${item.label}</button>`
          ).join('');
          break;

        case 2:
          gridStyle += 'grid-template-columns: 1fr 1fr; max-width: 200px;';
          gridHtml = visibleItems.map(item => 
            `<button class="portfolio-link" data-link-type="${item.type}">${item.label}</button>`
          ).join('');
          break;

        case 3:
          gridStyle += 'grid-template-columns: 1fr 1fr; max-width: 200px;';
          gridHtml = `
            <button class="portfolio-link" data-link-type="${visibleItems[0].type}">${visibleItems[0].label}</button>
            <button class="portfolio-link" data-link-type="${visibleItems[1].type}">${visibleItems[1].label}</button>
            <div style="grid-column: 1 / -1; display: flex; justify-content: center;">
              <button class="portfolio-link" data-link-type="${visibleItems[2].type}">${visibleItems[2].label}</button>
            </div>
          `;
          break;

        case 4:
          gridStyle += 'grid-template-columns: 1fr 1fr; max-width: 200px;';
          gridHtml = visibleItems.map(item => 
            `<button class="portfolio-link" data-link-type="${item.type}">${item.label}</button>`
          ).join('');
          break;

        case 5:
          gridStyle += 'grid-template-columns: 1fr 1fr; max-width: 200px;';
          gridHtml = `
            <button class="portfolio-link" data-link-type="${visibleItems[0].type}">${visibleItems[0].label}</button>
            <button class="portfolio-link" data-link-type="${visibleItems[1].type}">${visibleItems[1].label}</button>
            <button class="portfolio-link" data-link-type="${visibleItems[2].type}">${visibleItems[2].label}</button>
            <button class="portfolio-link" data-link-type="${visibleItems[3].type}">${visibleItems[3].label}</button>
            <div style="grid-column: 1 / -1; display: flex; justify-content: center;">
              <button class="portfolio-link" data-link-type="${visibleItems[4].type}">${visibleItems[4].label}</button>
            </div>
          `;
          break;

        case 6:
        default:
          gridStyle += 'grid-template-columns: 1fr 1fr 1fr; max-width: 300px;';
          gridHtml = visibleItems.map(item => 
            `<button class="portfolio-link" data-link-type="${item.type}">${item.label}</button>`
          ).join('');
          break;
      }

      // Render portfolio section
      portfolioSection.style.display = 'block';
      portfolioSection.innerHTML = `
        <h3>PORTFOLIO</h3>
        <div class="portfolio-links-grid" style="${gridStyle}">
          ${gridHtml}
        </div>
      `;

      // Attach click handlers to all portfolio buttons
      const buttons = portfolioSection.querySelectorAll('.portfolio-link');
      buttons.forEach((button) => {
        button.addEventListener('click', function(event) {
          event.stopPropagation(); // Prevent card flip

          const type = this.getAttribute('data-link-type');
          const linkMap = {
            cert: 'Certifications',
            edu: 'Education',
            proj: 'Projects',
            ref: 'References',
            resume: 'Resume',
            work: 'Work Experience'
          };

          // Get URL for this portfolio type
          const url = window.portfolioLinks && window.portfolioLinks[type] 
            ? window.portfolioLinks[type].trim() 
            : '';

          if (url) {
            // Open URL in new tab
            window.open(url, '_blank');
          } else {
            // Show appropriate message based on viewing mode
            const itemName = linkMap[type] || 'This item';

            if (viewingSharedCard) {
              alert(`No ${itemName} link available for this contact.`);
            } else {
              alert(`No link set for ${itemName}.\n\nAdd a URL in Settings to link to your portfolio.`);
            }
          }
        });
      });
    }

    /* ==========================================================
       RESET TO DEFAULT
       Clear saved data and reset to John Doe template
       ========================================================== */

    /**
     * Reset card to default John Doe template
     * Clears all saved data from localStorage
     */
    function resetToJohnDoe() {
      if (!confirm('Are you sure you want to reset to default? This will delete your current card.')) {
        return;
      }

      try {
        localStorage.removeItem('myCard');
      } catch (error) {
        console.error('Failed to clear card data:', error);
      }

      // Remove ?card= parameter from URL
      if (location.search.includes('card=')) {
        const cleanUrl = `${location.origin}${location.pathname}`;
        history.replaceState({}, '', cleanUrl);
      }

      // Reset viewing state
      viewingSharedCard = false;
      sharedCardData = null;

      // Apply default card
      applyCardData(DEFAULT_CARD);
      loadMyCardSection();

      alert('Card has been reset to default (John Doe).');
    }
  </script>
</body>
</html>